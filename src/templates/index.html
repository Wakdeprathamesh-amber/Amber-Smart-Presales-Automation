<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Presales Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">Amber Student Smart Presales</div>
        <div>
          <span id="global-loader" class="loader" style="display: none;"></span>
          <span>Welcome, User</span>
        </div>
      </div>
    </div>
  </header>

  <main class="dashboard">
    <div class="container">
      <div class="dashboard-header">
        <h1 class="dashboard-title">Lead Management Dashboard</h1>
        <div class="btn-group">
          <button id="refresh-btn" class="btn btn-secondary">
            <span class="btn-icon">üîÑ</span> Refresh
          </button>
          <button id="schedule-bulk-btn" class="btn btn-primary" style="display: none;">
            <span class="btn-icon">üìÖ</span> Schedule Calls (<span id="selected-count">0</span>)
          </button>
          <button id="bulk-call-btn" class="btn btn-secondary">
            <span class="btn-icon">üìû</span> Call All Eligible
          </button>
          <button id="retry-config-btn" class="btn btn-secondary">
            <span class="btn-icon">‚öôÔ∏è</span> Retry Settings
          </button>
          <button id="wa-settings-btn" class="btn btn-secondary">
            <span class="btn-icon">üí¨</span> WhatsApp Settings
          </button>
          <button id="email-settings-btn" class="btn btn-secondary">
            <span class="btn-icon">‚úâÔ∏è</span> Email Settings
          </button>
          <button id="add-lead-btn" class="btn btn-primary">
            <span class="btn-icon">+</span> Add Lead
          </button>
          <button id="upload-csv-btn" class="btn btn-primary">
            <span class="btn-icon">‚§¥Ô∏è</span> Upload CSV
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats">
        <div class="stat-card">
          <h3 class="stat-title">Total Leads</h3>
          <div class="stat-value" id="total-leads-count">0</div>
          <div class="stat-change positive">In Pipeline</div>
        </div>
        <div class="stat-card">
          <h3 class="stat-title">Completed Calls</h3>
          <div class="stat-value" id="completed-calls-count">0</div>
          <div class="stat-change">Successfully Connected</div>
        </div>
        <div class="stat-card">
          <h3 class="stat-title">Pending Calls</h3>
          <div class="stat-value" id="pending-calls-count">0</div>
          <div class="stat-change">Waiting for Processing</div>
        </div>
        <div class="stat-card">
          <h3 class="stat-title">Missed Calls</h3>
          <div class="stat-value" id="missed-calls-count">0</div>
          <div class="stat-change negative">Need Retry</div>
        </div>
        <div class="stat-card">
          <h3 class="stat-title">Qualified Leads</h3>
          <div class="stat-value" id="qualified-leads-count">0</div>
          <div class="stat-change positive">Ready for Follow-up</div>
        </div>
        <div class="stat-card" id="card-potential" title="Filter: Potential">
          <h3 class="stat-title">Potential</h3>
          <div class="stat-value" id="potential-calls-count">0</div>
          <div class="stat-change">Needs Clarification</div>
        </div>
        <div class="stat-card" id="card-notqualified" title="Filter: Not Qualified">
          <h3 class="stat-title">Not Qualified</h3>
          <div class="stat-value" id="not-qualified-count">0</div>
          <div class="stat-change">Closed Out</div>
        </div>
        <div class="stat-card" id="card-successful" title="Filter: Successful Conversations">
          <h3 class="stat-title">Successful Conversations</h3>
          <div class="stat-value" id="successful-conv-count">0</div>
          <div class="stat-change positive">Picked & Talked</div>
        </div>
        <div class="stat-card" id="card-voicemail" title="Filter: Voicemail">
          <h3 class="stat-title">Voicemail</h3>
          <div class="stat-value" id="voicemail-count">0</div>
          <div class="stat-change">Left to Retry</div>
        </div>
      </div>

      <!-- Leads Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Leads</h2>
        </div>
        <div class="card-body">
          <div class="filters">
            <div class="search-input">
              <input type="text" id="search-input" class="form-control" placeholder="Search leads...">
            </div>
            <div>
              <select id="status-filter" class="form-control">
                <option value="all">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="initiated">Initiated</option>
                <option value="answered">Answered</option>
                <option value="missed">Missed</option>
                <option value="failed">Failed</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
          
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" id="select-all-checkbox" title="Select All"></th>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th>Call Status</th>
                  <th>Success Status</th>
                  <th>Retry Count</th>
                  <th>Last Call Time</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="leads-table-body">
                <!-- Table rows will be populated by JavaScript -->
                <tr>
                  <td colspan="9" class="text-center">Loading leads...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Lead Modal -->
  <div id="add-lead-modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add New Lead</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="add-lead-form">
          <div class="form-group">
            <label for="name" class="form-label">Name</label>
            <input type="text" id="name" name="name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="number" class="form-label">Phone Number (with country code)</label>
            <div class="phone-input-group">
              <span class="phone-prefix">+</span>
              <input type="tel" id="number" name="number" class="form-control phone-input" placeholder="919876543210" pattern="[0-9]{10,15}" required>
            </div>
            <div class="form-hint">Enter full number with country code (e.g., 919876543210 for +91 9876543210)</div>
          </div>
          <div class="form-group">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" name="email" class="form-control">
          </div>
          <div class="form-group">
            <label for="partner" class="form-label">Partner (optional)</label>
            <input type="text" id="partner" name="partner" class="form-control" placeholder="e.g., CollegeDekho">
            <div class="form-hint">Will be used in calls/emails: "received your details via {partner}"</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Lead</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bulk Schedule Modal -->
  <div id="bulk-schedule-modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">üìÖ Schedule Bulk Calls</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="bulk-schedule-form">
          <div class="form-group">
            <label class="form-label">Selected Leads: <strong><span id="modal-selected-count">0</span></strong></label>
            <div class="form-hint">These leads will be called at the scheduled time</div>
          </div>
          
          <div class="form-group">
            <label for="schedule-date" class="form-label">Start Date</label>
            <input type="date" id="schedule-date" name="schedule-date" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="schedule-time" class="form-label">Start Time (IST) üáÆüá≥</label>
            <input type="time" id="schedule-time" name="schedule-time" class="form-control" required>
            <div class="form-hint">‚è∞ Indian Standard Time (IST/UTC+5:30) - All times are in India timezone</div>
          </div>
          
          <div class="form-group">
            <label for="parallel-calls" class="form-label">Parallel Calls</label>
            <select id="parallel-calls" name="parallel-calls" class="form-control">
              <option value="1">1 call at a time (Sequential)</option>
              <option value="3">3 calls at a time</option>
              <option value="5" selected>5 calls at a time (Recommended)</option>
              <option value="10">10 calls at a time</option>
            </select>
            <div class="form-hint">How many calls to make simultaneously. Check your Vapi plan limits.</div>
          </div>
          
          <div class="form-group">
            <label for="call-interval" class="form-label">Interval Between Batches</label>
            <select id="call-interval" name="call-interval" class="form-control">
              <option value="30">30 seconds</option>
              <option value="60">60 seconds</option>
              <option value="120" selected>120 seconds (2 minutes - Recommended)</option>
              <option value="180">180 seconds (3 minutes)</option>
            </select>
            <div class="form-hint">Time to wait before starting the next batch (default: 2 minutes)</div>
          </div>
          
          <div class="form-group">
            <div class="schedule-summary" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
              <h4 style="margin: 0 0 10px 0; font-size: 14px;">üìä Schedule Summary</h4>
              <div id="schedule-summary-content" style="font-size: 13px; color: #555;">
                Select date and time to see estimated completion
              </div>
            </div>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Schedule Calls</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Lead Details Modal -->
  <div id="lead-details-modal" class="modal-backdrop">
    <div class="modal modal-large">
      <div class="modal-header">
        <h3 class="modal-title">Lead Details</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="lead-details-content">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary modal-close">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Upload CSV Modal -->
  <div id="upload-csv-modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Upload Leads (CSV)</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="upload-csv-form">
          <div class="form-group">
            <label class="form-label">CSV File</label>
            <input type="file" id="csv-file-input" name="file" accept=".csv" class="form-control" required>
            <div class="form-hint">Headers: number,name,email,whatsapp_number(optional),partner(optional)</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Retry Configuration Modal -->
  <div id="retry-config-modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Retry Configuration</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="retry-config-form">
          <div class="form-group">
            <label for="max-retries" class="form-label">Maximum Retry Attempts</label>
            <input type="number" id="max-retries" name="max_retries" class="form-control" min="1" value="3" required>
            <div class="form-hint">How many times to retry missed calls before giving up</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Retry Intervals</label>
            <div class="form-hint">How long to wait between retry attempts</div>
            
            <div id="retry-intervals-container">
              <!-- Will be populated by JavaScript -->
            </div>
            
            <button type="button" id="add-interval-btn" class="btn btn-secondary btn-sm">
              <span class="btn-icon">+</span> Add Interval
            </button>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Configuration</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- WhatsApp Settings Modal -->
  <div id="wa-settings-modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">WhatsApp Settings</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="wa-settings-form">
          <div class="form-group">
            <label class="form-label">Enable Follow-up (after completed call)</label>
            <select id="wa-enable-followup" class="form-control">
              <option value="true">Enabled</option>
              <option value="false">Disabled</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Enable Fallback (after max retries)</label>
            <select id="wa-enable-fallback" class="form-control">
              <option value="true">Enabled</option>
              <option value="false">Disabled</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Follow-up Template Name</label>
            <input type="text" id="wa-template-followup" class="form-control" placeholder="e.g., followup_after_call">
          </div>
          <div class="form-group">
            <label class="form-label">Fallback Template Name</label>
            <input type="text" id="wa-template-fallback" class="form-control" placeholder="e.g., fallback_after_retries">
          </div>
          <div class="form-group">
            <label class="form-label">Language Code</label>
            <input type="text" id="wa-language" class="form-control" placeholder="en or en_US">
          </div>
          <div class="form-group">
            <label class="form-label">Preview</label>
            <div id="wa-preview" class="form-hint">Template preview will appear here (uses lead name as {{1}}).</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Settings</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Email Settings Modal -->
  <div id="email-settings-modal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Email Settings</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="email-settings-form">
          <div class="form-group">
            <label class="form-label">Subject</label>
            <input type="text" id="email-subject" class="form-control" placeholder="Welcome to Amber">
          </div>
          <div class="form-group">
            <label class="form-label">Body (supports {name})</label>
            <textarea id="email-body" class="form-control" rows="8" placeholder="Hi {name},\n\nAmber helps with student housing...\n"></textarea>
            <div class="form-hint">Variables: {name}</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Settings</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>
